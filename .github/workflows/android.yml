name: Direct Android SDK Build

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:

jobs:
  build:
    name: Build with Android SDK Tools
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Project Analysis
      run: |
        echo "=== Legacy Android Project ==="
        echo "Package: $(grep -o 'package="[^"]*"' AndroidManifest.xml | cut -d'"' -f2)"
        echo "Java files: $(find src -name "*.java" 2>/dev/null | wc -l)"
        echo "JAR libraries: $(find libs -name "*.jar" 2>/dev/null | wc -l)"
        echo "Resources: $(find res -type f 2>/dev/null | wc -l)"
        
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup minimal Android SDK
      run: |
        # Create Android SDK directory
        export ANDROID_HOME=$HOME/android-sdk
        mkdir -p $ANDROID_HOME
        
        # Download minimal SDK
        cd /tmp
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-9477386_latest.zip
        mv cmdline-tools $ANDROID_HOME/cmdline-tools-temp
        mkdir -p $ANDROID_HOME/cmdline-tools
        mv $ANDROID_HOME/cmdline-tools-temp $ANDROID_HOME/cmdline-tools/latest
        
        # Install required packages
        export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin
        yes | sdkmanager --licenses >/dev/null 2>&1
        sdkmanager "platform-tools" "build-tools;30.0.3" "platforms;android-28" >/dev/null
        
        # Set environment for next steps
        echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
        echo "$ANDROID_HOME/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
        echo "$ANDROID_HOME/build-tools/30.0.3" >> $GITHUB_PATH
        
        # Verify installation
        echo "SDK installed. Build tools version:"
        ls $ANDROID_HOME/build-tools/
        
    - name: Prepare build directories
      run: |
        mkdir -p build/classes
        mkdir -p build/gen
        mkdir -p build/res
        echo "Build directories created"
        
    - name: Generate R.java
      run: |
        echo "Generating R.java with aapt..."
        
        # Generate R.java file
        $ANDROID_HOME/build-tools/30.0.3/aapt package \
          --auto-add-overlay \
          -f \
          -m \
          -J build/gen \
          -S res \
          -M AndroidManifest.xml \
          -I $ANDROID_HOME/platforms/android-28/android.jar \
          --debug-mode || echo "R.java generation failed, continuing..."
          
        echo "Generated files in build/gen:"
        find build/gen -name "*.java" 2>/dev/null || echo "No R.java files generated"
        
    - name: Compile Java sources
      run: |
        echo "Compiling Java sources..."
        
        # Create sources list
        find src -name "*.java" > build/sources.txt 2>/dev/null || touch build/sources.txt
        find build/gen -name "*.java" >> build/sources.txt 2>/dev/null || true
        
        if [ -s build/sources.txt ]; then
          echo "Found $(wc -l < build/sources.txt) Java files to compile"
          
          # Build classpath
          CLASSPATH="$ANDROID_HOME/platforms/android-28/android.jar"
          
          # Add JAR libraries
          if [ -d libs ]; then
            for jar in libs/*.jar; do
              if [ -f "$jar" ]; then
                CLASSPATH="$CLASSPATH:$jar"
                echo "Added to classpath: $jar"
              fi
            done
          fi
          
          # Compile with explicit options
          javac \
            -d build/classes \
            -cp "$CLASSPATH" \
            -sourcepath src:build/gen \
            -target 1.8 \
            -source 1.8 \
            @build/sources.txt || echo "Compilation failed, continuing..."
            
          echo "Compiled classes:"
          find build/classes -name "*.class" | wc -l
        else
          echo "No Java source files found"
        fi
        
    - name: Create DEX file
      run: |
        if [ -d build/classes ] && [ "$(find build/classes -name "*.class" | head -1)" ]; then
          echo "Creating DEX file..."
          
          $ANDROID_HOME/build-tools/30.0.3/dx \
            --dex \
            --output=build/classes.dex \
            build/classes || echo "DEX creation failed"
            
          if [ -f build/classes.dex ]; then
            echo "DEX file created: $(ls -lh build/classes.dex | awk '{print $5}')"
          fi
        else
          echo "No compiled classes found, skipping DEX creation"
        fi
        
    - name: Package APK
      run: |
        echo "Packaging APK..."
        
        # Package resources and manifest
        $ANDROID_HOME/build-tools/30.0.3/aapt package \
          -f \
          -M AndroidManifest.xml \
          -S res \
          -I $ANDROID_HOME/platforms/android-28/android.jar \
          -F build/app-unsigned.apk \
          --debug-mode || echo "Initial APK packaging failed"
          
        # Add DEX file if it exists
        if [ -f build/classes.dex ] && [ -f build/app-unsigned.apk ]; then
          echo "Adding DEX to APK..."
          $ANDROID_HOME/build-tools/30.0.3/aapt add build/app-unsigned.apk build/classes.dex || echo "Adding DEX failed"
        fi
        
        # Add native libraries if they exist
        if [ -d libs ]; then
          for so_file in $(find libs -name "*.so" 2>/dev/null); do
            echo "Adding native library: $so_file"
            $ANDROID_HOME/build-tools/30.0.3/aapt add build/app-unsigned.apk "$so_file" || true
          done
        fi
        
        if [ -f build/app-unsigned.apk ]; then
          echo "APK created successfully: $(ls -lh build/app-unsigned.apk | awk '{print $5}')"
          
          # Create debug version
          cp build/app-unsigned.apk build/ApkDownloader-debug.apk
          echo "Debug APK: build/ApkDownloader-debug.apk"
        else
          echo "APK creation failed"
        fi
        
    - name: APK Information
      if: always()
      run: |
        echo "=== Build Results ==="
        
        for apk in $(find build -name "*.apk" 2>/dev/null); do
          echo "APK: $apk"
          echo "Size: $(ls -lh "$apk" | awk '{print $5}')"
          
          # Try to get APK info
          if command -v aapt >/dev/null 2>&1; then
            echo "Package info:"
            aapt dump badging "$apk" 2>/dev/null | head -3 || echo "Cannot read APK info"
          fi
          echo "---"
        done
        
        # List all build artifacts
        echo "Build directory contents:"
        find build -type f -name "*" | head -20
        
    - name: Upload APK
      uses: actions/upload-artifact@v4
      if: always()
      continue-on-error: true
      with:
        name: android-apk-direct-build
        path: |
          build/*.apk
        retention-days: 30
        
    - name: Upload build artifacts (debug)
      uses: actions/upload-artifact@v4
      if: failure()
      continue-on-error: true
      with:
        name: build-debug-info
        path: |
          build/sources.txt
          build/gen/
          AndroidManifest.xml
          project.properties
        retention-days: 7
